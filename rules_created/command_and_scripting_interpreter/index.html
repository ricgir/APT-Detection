<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Command and Scripting Interpreter - APT Detection using ELK Stack</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Command and Scripting Interpreter";
        var mkdocs_page_input_path = "rules_created/command_and_scripting_interpreter.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> APT Detection using ELK Stack
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../overall_workflow/">Overall Workflow</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../apt_lifecycle/">APT lifecycle</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Setup</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/elk_setup/">ELK</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/vm_setup/">Virtual Machine</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/art_setup/">Atomic Red Team</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Rules created</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../active_scanning/">Active Scanning</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../phishing/">Phishing</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Command and Scripting Interpreter</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#description">Description</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rule-derivation-from-log-analysis">Rule Derivation from Log Analysis</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-defining-the-behavior">1. Defining the Behavior:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2translating-behavior-to-log-fields">2.Translating Behavior to Log Fields:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-constructing-the-rule">3. Constructing the Rule:</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#detection-logic">Detection Logic</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#query">Query:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#breakdown">Breakdown:</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#simulation-and-validation">Simulation and Validation</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../boot_or_logon_autostart_execution/">Boot or Logon Autostart Execution</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../abuse_elevation_control_mechanism/">Abuse Elevation Control Mechanism</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../obfuscated_files_or_information/">Obfuscated Files or Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../os_credential_dumping/">OS Credential Dumping</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../system_information_discovery/">System Information Discovery</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../remote_services/">Remote Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../automated_collection/">Automated Collection</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../application_layer_protocol/">Application Layer Protocol</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exfiltration_over_alternative_protocol/">Exfiltration Over Alternative Protocol</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">APT Detection using ELK Stack</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Rules created</li>
      <li class="breadcrumb-item active">Command and Scripting Interpreter</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="detection-rule-execution-via-powershell-download">Detection Rule: Execution via PowerShell Download</h1>
<p>Rule ID: <strong>c99f9f9a-b0bd-49dc-b3af-3d837cfb64e1</strong></p>
<p>Rule Name: Execution (T1059: Command and Scripting Interpreter)</p>
<p>MITRE ATT&amp;CK Tactic: <a href="https://attack.mitre.org/tactics/TA0002/">Execution</a></p>
<p>MITRE ATT&amp;CK Technique: <a href="https://attack.mitre.org/techniques/T1059/001/">T1059.001, Command and Scripting Interpreter: PowerShell</a></p>
<h2 id="description">Description</h2>
<p>This rule detects an adversary using Windows PowerShell to download a file from an external source. After gaining initial access, attackers often use this technique to retrieve their primary malware, tools, or second-stage payloads from a command-and-control (C2) server onto the compromised host.</p>
<p>Because PowerShell is a legitimate and powerful administration tool installed on all modern Windows systems, its activity can blend in with normal operations, making it a favored tool for "living off the land." An alert from this rule is a strong indicator that an active payload is being introduced into the environment.</p>
<h2 id="rule-derivation-from-log-analysis">Rule Derivation from Log Analysis</h2>
<p>This rule's logic was derived by identifying the specific command-line artifacts left behind when PowerShell is used for network downloads.</p>
<h3 id="1-defining-the-behavior"><strong>1. Defining the Behavior</strong>:</h3>
<p>The core behavior is the execution of powershell.exe with command-line arguments that instruct it to initiate a file download from a URL.</p>
<h3 id="2translating-behavior-to-log-fields"><strong>2.Translating Behavior to Log Fields</strong>:</h3>
<p>This activity is captured entirely within process execution logs:</p>
<ul>
<li>The process being run is identified in the <code>process.name field</code> (i.e., powershell.exe).</li>
<li>The specific download instructions are found in the <code>process.command_line</code> field.</li>
</ul>
<h3 id="3-constructing-the-rule"><strong>3. Constructing the Rule</strong>:</h3>
<p>We identified the most common PowerShell classes, cmdlets, and aliases used for downloading files. These include the <code>.NET</code> class <code>System.Net.WebClient</code> and its methods (DownloadFile, DownloadString), as well as the native PowerShell cmdlets <code>Invoke-WebRequest</code> (aliased as iwr) and wget. The rule logic was then built to search for the execution of powershell.exe where any of these specific, high-fidelity strings are present in the command line.</p>
<h2 id="detection-logic">Detection Logic</h2>
<p>This is a query-based rule that triggers on a single process creation event.</p>
<h3 id="query">Query:</h3>
<p><code>process.name:powershell.exe and process.command_line:(*System.Net.WebClient* or *DownloadFile* or *DownloadString* or *iwr* or *wget*)</code></p>
<h3 id="breakdown">Breakdown:</h3>
<p><strong>process.name:powershell.exe</strong>: The rule first looks for any event where the powershell.exe process is started.</p>
<p><strong>and</strong>: It then requires the second condition to also be true.</p>
<p><strong>process.command_line:(...)</strong>: The rule inspects the full command line used to launch PowerShell. It triggers if it finds any of the following keywords, which are commonly used to download files:</p>
<ul>
<li>
<p>System.Net.WebClient, DownloadFile, DownloadString: Methods from the .NET Framework for web requests.</p>
</li>
<li>
<p>iwr: A standard alias for the Invoke-WebRequest cmdlet.</p>
</li>
<li>
<p>wget: A common alias for the Invoke-WebRequest cmdlet, familiar to Linux users.</p>
</li>
</ul>
<p>In short, the rule alerts whenever PowerShell is launched with a command that explicitly instructs it to download content from the internet.</p>
<h2 id="simulation-and-validation">Simulation and Validation</h2>
<p>This rule can be validated by running a simple PowerShell command to download a benign file from the internet.</p>
<p><strong>Atomic Red Team Test Command:</strong></p>
<p><code>powershell.exe -Command "Invoke-WebRequest -Uri https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/LICENSE.txt -OutFile C:\Users\Public\license.txt"</code></p>
<p>This command starts PowerShell and uses the Invoke-WebRequest cmdlet (iwr) to download the LICENSE.txt file from the official Atomic Red Team GitHub repository and save it to the public user's directory. This action directly matches the process.name and process.command_line logic in the rule and will generate an alert.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../phishing/" class="btn btn-neutral float-left" title="Phishing"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../boot_or_logon_autostart_execution/" class="btn btn-neutral float-right" title="Boot or Logon Autostart Execution">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../phishing/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../boot_or_logon_autostart_execution/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
