<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Obfuscated Files or Information - APT Detection using ELK Stack</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Obfuscated Files or Information";
        var mkdocs_page_input_path = "rules_created/obfuscated_files_or_information.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> APT Detection using ELK Stack
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../overall_workflow/">Overall Workflow</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../apt_lifecycle/">APT lifecycle</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Setup</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/elk_setup/">ELK</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/vm_setup/">Virtual Machine</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/art_setup/">Atomic Red Team</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Rules created</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../active_scanning/">Active Scanning</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../phishing/">Phishing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../command_and_scripting_interpreter/">Command and Scripting Interpreter</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../boot_or_logon_autostart_execution/">Boot or Logon Autostart Execution</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../abuse_elevation_control_mechanism/">Abuse Elevation Control Mechanism</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Obfuscated Files or Information</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#description">Description</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rule-derivation-from-log-analysis">Rule Derivation from Log Analysis</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-defining-the-behavior">1. Defining the Behavior:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-translating-behavior-to-log-fields">2. Translating Behavior to Log Fields:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-constructing-the-rule">3. Constructing the Rule:</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#detection-logic">Detection Logic</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#windows">Windows</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ubuntu-hiding-data-with-dd">Ubuntu: Hiding Data with dd</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#simulation-and-validation">Simulation and Validation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#windows_1">Windows</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ubuntu">Ubuntu</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../os_credential_dumping/">OS Credential Dumping</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../system_information_discovery/">System Information Discovery</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../remote_services/">Remote Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../automated_collection/">Automated Collection</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../application_layer_protocol/">Application Layer Protocol</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exfiltration_over_alternative_protocol/">Exfiltration Over Alternative Protocol</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">APT Detection using ELK Stack</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Rules created</li>
      <li class="breadcrumb-item active">Obfuscated Files or Information</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="detection-rule-defense-evasion-via-encoded-powershell-command">Detection Rule: Defense Evasion via Encoded PowerShell Command</h1>
<p>Rule ID: <strong>9ddec47a-5d4c-465c-be29-ea27ce6340b8</strong></p>
<p>Rule Name: Defense Evasion (T1027: Obfuscated Files or Information)</p>
<p>MITRE ATT&amp;CK Tactic: <a href="https://attack.mitre.org/tactics/TA0005/">Defense Evasion</a></p>
<p>MITRE ATT&amp;CK Technique: <a href="https://attack.mitre.org/techniques/T1027/">T1027, Obfuscated Files or Information</a></p>
<h2 id="description">Description</h2>
<p>This rule detects attackers using obfuscation techniques to hide their commands, tools, or data from security software. By encoding commands or hiding files, adversaries can evade signature-based scanners and manual inspection. An alert from this rule is a strong indicator of intentional evasion. </p>
<p>On Windows, a classic technique is using <strong>Base64-encoded PowerShell commands</strong>. This abuses a legitimate feature to hide malicious keywords from detection. On Linux, evasion can involve hiding data in less common locations like alternate data streams or simply storing tools and payloads in hidden <strong>"dotfiles"</strong>.</p>
<h2 id="rule-derivation-from-log-analysis">Rule Derivation from Log Analysis</h2>
<p>The logic for this rule focuses on the specific artifacts of the obfuscation method, rather than the unreadable obfuscated content itself.</p>
<h3 id="1-defining-the-behavior"><strong>1. Defining the Behavior</strong>:</h3>
<p>The goal is to detect the execution of a command or tool that is specifically designed to handle obfuscated data.</p>
<ul>
<li>
<p><strong>Windows</strong>: The key behavior is the execution of <code>powershell.exe</code> with a specific command-line switch (<code>-EncodedCommand</code>) that instructs it to decode and run a Base64 string.</p>
</li>
<li>
<p><strong>Linux</strong>: The behavior involves using a powerful utility like <code>dd</code> with a specific syntax (<code>of=*:*</code>) that indicates writing to a non-standard file stream.</p>
</li>
</ul>
<h3 id="2-translating-behavior-to-log-fields"><strong>2. Translating Behavior to Log Fields</strong>:</h3>
<p>This information is found within process creation logs:</p>
<ul>
<li>
<p>The executed process is in <code>process.name</code> (e.g., <code>powershell.exe</code>, <code>dd</code>).</p>
</li>
<li>
<p>The specific switches or arguments are in <code>process.args</code> or <code>process.command_line</code>.</p>
</li>
</ul>
<h3 id="3-constructing-the-rule"><strong>3. Constructing the Rule</strong>:</h3>
<p>We identified the unique command-line arguments used for these techniques. The rule triggers when it sees a process launched with these high-fidelity indicators. While these features have legitimate uses, they are far more common in malicious and unauthorized activity.</p>
<h2 id="detection-logic">Detection Logic</h2>
<h3 id="windows">Windows</h3>
<p>This is a query-based rule that triggers on a single process creation event.</p>
<p><strong>Query</strong>:</p>
<p><code>process.name : "powershell.exe" AND (process.args:"-e" OR process.args:"-en" OR process.args:"-enc" OR process.args:"-encodedcommand")</code></p>
<p><strong>Query Explanation</strong>:</p>
<p>The query identifies events where the PowerShell interpreter is launched with arguments that specify an encoded command.</p>
<ul>
<li>
<p>The <code>process.name : "powershell.exe"</code> clause filters for events where the PowerShell process is started.</p>
</li>
<li>
<p>The AND (...) clause provides the core logic, checking if the process arguments (<code>process.args</code>) contain any of the switches used to pass a Base64-encoded command string: -e, -en, -enc, or the full -encodedcommand.</p>
</li>
</ul>
<p>The rule triggers an alert if powershell.exe is executed with any of these specific command-line switches.</p>
<h3 id="ubuntu-hiding-data-with-dd">Ubuntu: Hiding Data with <code>dd</code></h3>
<p><strong>Query</strong>:</p>
<p><code>process.name:"dd" and process.command_line: "*of=*:*"</code></p>
<p>This query looks for the use of the <code>dd</code> utility with a command line that contains <code>of=*:*</code>. This syntax can be used to write to an alternate data stream on certain file systems, a technique for hiding malicious data from normal view.</p>
<h2 id="simulation-and-validation">Simulation and Validation</h2>
<h3 id="windows_1">Windows</h3>
<p>This rule can be validated by encoding a simple command into Base64 and executing it using the <code>-EncodedCommand</code> switch.</p>
<p><strong>Test Command (PowerShell)</strong>:</p>
<p><code>powershell.exe -EncodedCommand dwBoAG8AYQBtAGkA</code></p>
<p>This command executes PowerShell and instructs it to run an encoded command. The Base64 string dwBoAG8AYQBtAGkA decodes to the simple command whoami. The PowerShell process decodes the string and executes whoami in memory. This action, which uses powershell.exe and the <code>-EncodedCommand</code> switch (which can be shortened to <code>-e, -en, or -enc</code>), directly matches the rule's logic and will generate an alert.</p>
<h3 id="ubuntu">Ubuntu</h3>
<p>This test simulates a simple but effective evasion technique: hiding a file by naming it with a leading dot.</p>
<p><strong>Test Command</strong>:</p>
<p><code>echo "hidden malware" &gt; ~/.im_not_a_virus</code></p>
<p>This command creates a new file named <code>.im_not_a_virus</code> in the user's home directory. In Linux, files starting with a dot (<code>.</code>) are hidden from standard directory listings (like <code>ls</code>). This simulates an attacker trying to hide their artifacts on the system and is a common form of defense evasion.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../abuse_elevation_control_mechanism/" class="btn btn-neutral float-left" title="Abuse Elevation Control Mechanism"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../os_credential_dumping/" class="btn btn-neutral float-right" title="OS Credential Dumping">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../abuse_elevation_control_mechanism/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../os_credential_dumping/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
