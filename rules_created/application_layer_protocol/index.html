<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Application Layer Protocol - APT Detection using ELK Stack</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Application Layer Protocol";
        var mkdocs_page_input_path = "rules_created/application_layer_protocol.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> APT Detection using ELK Stack
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../overall_workflow/">Overall Workflow</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../apt_lifecycle/">APT lifecycle</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Setup</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/elk_setup/">ELK</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/vm_setup/">Virtual Machine</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/art_setup/">Atomic Red Team</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Rules created</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../active_scanning/">Active Scanning</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../phishing/">Phishing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../command_and_scripting_interpreter/">Command and Scripting Interpreter</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../boot_or_logon_autostart_execution/">Boot or Logon Autostart Execution</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../abuse_elevation_control_mechanism/">Abuse Elevation Control Mechanism</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../obfuscated_files_or_information/">Obfuscated Files or Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../os_credential_dumping/">OS Credential Dumping</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../system_information_discovery/">System Information Discovery</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../remote_services/">Remote Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../automated_collection/">Automated Collection</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Application Layer Protocol</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#description">Description</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rule-derivation-from-log-analysis">Rule Derivation from Log Analysis</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-defining-the-behavior">1. Defining the Behavior:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-translating-behavior-to-log-fields">2. Translating Behavior to Log Fields:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-constructing-the-rule">3. Constructing the Rule:</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#detection-logic">Detection Logic</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#query">Query:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#query-explanation">Query Explanation:</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#simulation-and-validation">Simulation and Validation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#atomic-red-team-test-command">Atomic Red Team Test Command:</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exfiltration_over_alternative_protocol/">Exfiltration Over Alternative Protocol</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">APT Detection using ELK Stack</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Rules created</li>
      <li class="breadcrumb-item active">Application Layer Protocol</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="detection-rule-c2-via-application-layer-protocol">Detection Rule: C2 via Application Layer Protocol</h1>
<p>Rule ID: <strong>a2b74aea-b267-4ddd-9a51-bac87083d306</strong></p>
<p>Rule Name: Command and Control (T1071: Application Layer Protocol)</p>
<p>MITRE ATT&amp;CK Tactic: <a href="https://attack.mitre.org/tactics/TA0011/">Command and Control</a></p>
<p>MITRE ATT&amp;CK Technique: <a href="https://attack.mitre.org/techniques/T1071/">T1071, Application Layer Protocol</a></p>
<h2 id="description">Description</h2>
<p>Adversaries use common protocols like <strong>HTTP</strong> or <strong>HTTPS</strong> for their command and control (C2) communications to blend in with legitimate network traffic.</p>
<p>This rule detects this behavior by identifying network connections to standard web ports (80/443) that originate from non-browser processes. While it's normal for browsers like Chrome or Firefox to connect to these ports, it is highly suspicious when other programs (like <code>cmd.exe</code>, <code>powershell.exe</code>, or an unknown executable) do so, as this can indicate a malware beacon.</p>
<h2 id="rule-derivation-from-log-analysis">Rule Derivation from Log Analysis</h2>
<p>The logic for this rule was developed by baselining normal web traffic and then hunting for outliers.</p>
<h3 id="1-defining-the-behavior"><strong>1. Defining the Behavior</strong>:</h3>
<p>The goal was to find C2 traffic hiding as legitimate web browsing. The key differentiator is the <strong>source process</strong>. Legitimate HTTP/S traffic originates from a web browser or a few core system processes. Malicious C2 traffic often originates from malware, droppers, or script interpreters.</p>
<h3 id="2-translating-behavior-to-log-fields"><strong>2. Translating Behavior to Log Fields</strong>:</h3>
<p>This behavior is observed in network connection logs.</p>
<ul>
<li>
<p>The network protocol is identified by the destination.port (80 for HTTP, 443 for HTTPS).</p>
</li>
<li>
<p>The source process is identified by <code>process.name</code>.</p>
</li>
</ul>
<h3 id="3-constructing-the-rule"><strong>3. Constructing the Rule</strong>:</h3>
<p>The query was built using an exclusion model. It looks for all traffic on web ports and then explicitly excludes connections from known, legitimate browsers and system processes. Any remaining traffic is flagged as suspicious, providing a powerful way to spot hidden C2 channels.</p>
<h2 id="detection-logic">Detection Logic</h2>
<p>This is a query-based rule that triggers on a single network connection event.</p>
<h3 id="query">Query:</h3>
<p><code>event.category:network and destination.port:(80 or 443) and not process.name:("chrome.exe" or "firefox.exe" or "msedge.exe" or "iexplore.exe" or "svchost.exe")</code></p>
<h3 id="query-explanation">Query Explanation:</h3>
<p>The query identifies network traffic from non-standard applications to web ports.</p>
<ul>
<li>
<p><code>event.category:network</code>: This clause filters events to only include network connections.</p>
</li>
<li>
<p><code>destination.port:(80 or 443)</code>: This filters for traffic directed to the standard ports for HTTP (80) and HTTPS (443).</p>
</li>
<li>
<p><code>not process.name:(...)</code>: This is the core logic, which excludes traffic originating from common web browsers and the Windows Service Host (svchost.exe).</p>
</li>
</ul>
<h2 id="simulation-and-validation">Simulation and Validation</h2>
<p>This rule can be validated by initiating a web request from a non-browser application, such as PowerShell.</p>
<h3 id="atomic-red-team-test-command">Atomic Red Team Test Command:</h3>
<p><code>Invoke-WebRequest -Uri https://www.google.com</code></p>
<p>This command uses PowerShell's Invoke-WebRequest cmdlet to download the homepage of Google. This creates a network connection from the <code>powershell.exe</code> process to a destination on port 443 (HTTPS). Since powershell.exe is not in the rule's exclusion list, this action directly matches the rule's logic and will generate an alert.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../automated_collection/" class="btn btn-neutral float-left" title="Automated Collection"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../exfiltration_over_alternative_protocol/" class="btn btn-neutral float-right" title="Exfiltration Over Alternative Protocol">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../automated_collection/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../exfiltration_over_alternative_protocol/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
