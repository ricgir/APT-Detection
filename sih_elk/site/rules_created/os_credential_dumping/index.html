<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>OS Credential Dumping - APT Detection using ELK Stack</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "OS Credential Dumping";
        var mkdocs_page_input_path = "rules_created/os_credential_dumping.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> APT Detection using ELK Stack
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../overall_workflow/">Overall Workflow</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../apt_lifecycle/">APT lifecycle</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Setup</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/elk_setup/">ELK</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/vm_setup/">Virtual Machine</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/art_setup/">Atomic Red Team</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Rules created</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../active_scanning/">Active Scanning</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../phishing/">Phishing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../command_and_scripting_interpreter/">Command and Scripting Interpreter</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../boot_or_logon_autostart_execution/">Boot or Logon Autostart Execution</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../abuse_elevation_control_mechanism/">Abuse Elevation Control Mechanism</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../obfuscated_files_or_information/">Obfuscated Files or Information</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">OS Credential Dumping</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#description">Description</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rule-derivation-from-log-analysis">Rule Derivation from Log Analysis</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-defining-the-behavior">1. Defining the Behavior:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-translating-behavior-to-log-fields">2. Translating Behavior to Log Fields:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-constructing-the-rule">3. Constructing the Rule:</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#detection-logic">Detection Logic</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#windows-lsass-process-masquerading">Windows: LSASS Process Masquerading</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ubuntu-unauthorized-etcshadow-access">Ubuntu: Unauthorized /etc/shadow Access</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#simulation-and-validation">Simulation and Validation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#windows">Windows</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ubuntu">Ubuntu</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../system_information_discovery/">System Information Discovery</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../remote_services/">Remote Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../automated_collection/">Automated Collection</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../application_layer_protocol/">Application Layer Protocol</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exfiltration_over_alternative_protocol/">Exfiltration Over Alternative Protocol</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">APT Detection using ELK Stack</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Rules created</li>
      <li class="breadcrumb-item active">OS Credential Dumping</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="detection-rule-os-credential-dumping-via-lsass">Detection Rule: OS Credential Dumping via LSASS</h1>
<p>Rule ID: <strong>49fcd163-9359-4472-8f27-47315023d94a</strong></p>
<p>Rule Name: Credential Access (T1003: OS Credential Dumping)</p>
<p>MITRE ATT&amp;CK Tactic: <a href="https://attack.mitre.org/tactics/TA0006/">Credential Access</a></p>
<p>MITRE ATT&amp;CK Technique: <a href="https://attack.mitre.org/techniques/T1003/">T1003, OS Credential Dumping</a></p>
<h2 id="description">Description</h2>
<p>This rule detects adversaries attempting to extract account login and credential material directly from the operating system. This is a critical step for attackers to escalate privileges and move laterally across a network.</p>
<p>On <strong>Windows</strong>, a primary target for this is the <strong>Local Security Authority Subsystem Service (LSASS)</strong> process memory, which stores valuable credentials like password hashes for active users. On <strong>Linux</strong>, the equivalent is the <code>/etc/shadow</code> file, which contains the hashed passwords for all local user accounts.</p>
<h2 id="rule-derivation-from-log-analysis">Rule Derivation from Log Analysis</h2>
<p>The logic for this rule is based on identifying highly suspicious activities directed at these critical credential stores.</p>
<h3 id="1-defining-the-behavior"><strong>1. Defining the Behavior</strong>:</h3>
<p>The goal is to detect unauthorized access to credential storage locations.</p>
<ul>
<li>
<p><strong>Windows (Masquerading)</strong>: The provided rule detects a common precursor or accompanying technique where malware <strong>masquerades as the LSASS process</strong> to hide its activity. Any creation of <code>lsass.exe</code> by an unexpected parent process is a strong indicator of malicious intent.</p>
</li>
<li>
<p><strong>Linux (Direct Access)</strong>: The logic focuses on detecting direct, unauthorized access to the <code>/etc/shadow</code> file. Legitimate access to this file is rare and performed only by a few known system utilities.</p>
</li>
</ul>
<h3 id="2-translating-behavior-to-log-fields"><strong>2. Translating Behavior to Log Fields</strong>:</h3>
<ul>
<li>
<p><strong>Windows</strong>: The detection uses process creation logs, focusing on <code>process.name</code> and the parent process <code>source.process.executable</code>.</p>
</li>
<li>
<p><strong>Linux</strong>: The detection uses file access logs, focusing on file.path, event.action, and the <code>process.name</code> that is accessing the file.</p>
</li>
</ul>
<h3 id="3-constructing-the-rule"><strong>3. Constructing the Rule</strong>:</h3>
<p>The query is constructed to specifically look for the creation of <code>lsass.exe</code> while excluding a shortlist of common system processes that might be false positives. Any other parent process is flagged as suspicious, providing a high-fidelity alert for this masquerading technique.</p>
<h2 id="detection-logic">Detection Logic</h2>
<h3 id="windows-lsass-process-masquerading">Windows: LSASS Process Masquerading</h3>
<p>This is a query-based rule that triggers on a single process creation event.</p>
<p><strong>Query</strong>:</p>
<p><code>event.category:process and event.action:"Process Create" and process.name:lsass.exe and source.process.executable:* and not source.process.executable:("C:\\Windows\\System32\\svchost.exe" or "C:\\Windows\\System32\\services.exe")</code></p>
<p><strong>Query Explanation</strong>:</p>
<p>The query identifies events where a process named lsass.exe is created by an unauthorized parent process.</p>
<ul>
<li>
<p><code>event.category:process and event.action:"Process Create"</code>: This clause filters events to only include new process creations.</p>
</li>
<li>
<p><code>process.name:lsass.exe</code>: This specifically looks for the creation of a process with the name lsass.exe.</p>
</li>
<li>
<p><code>not source.process.executable:(...)</code>: This clause excludes legitimate system processes (svchost.exe, services.exe) from being flagged as the parent, reducing potential noise.</p>
</li>
</ul>
<p>The rule triggers an alert if lsass.exe is created by any process not on the exclusion list, which is highly anomalous behavior.</p>
<h3 id="ubuntu-unauthorized-etcshadow-access">Ubuntu: Unauthorized /etc/shadow Access</h3>
<p>This query alerts when a process other than a standard system utility attempts to read the <code>/etc/shadow</code> file.</p>
<p><strong>Query</strong>:</p>
<p><code>file.path:"/etc/shadow" and event.action:"opened" and not process.name:("passwd" or "chage" or "useradd" or "login")</code></p>
<p>Direct access to <code>/etc/shadow</code> is highly suspicious. This query looks for any process reading this file that isn't a known, legitimate utility for managing passwords and users.</p>
<h2 id="simulation-and-validation">Simulation and Validation</h2>
<h3 id="windows">Windows</h3>
<p>This rule can be validated by simulating a malware masquerading technique where a common utility is renamed to <code>lsass.exe</code> and executed.</p>
<p><strong>Test Command (PowerShell)</strong>:</p>
<p><code>copy C:\Windows\System32\whoami.exe C:\Users\Public\lsass.exe
C:\Users\Public\lsass.exe</code></p>
<p>This test first copies a harmless utility, whoami.exe, to a new location and renames it to <code>lsass.exe</code>. When the renamed file is executed, a new process named lsass.exe is created. The parent process will be the shell that executed the command (e.g., cmd.exe or powershell.exe), which is not on the rule's exclusion list. This action directly matches the rule's logic and will generate an alert.</p>
<h3 id="ubuntu">Ubuntu</h3>
<p>This test simulates a direct attempt to read the credential file.</p>
<p><strong>Test Command</strong>:</p>
<p><code>sudo cat /etc/shadow</code></p>
<p>This command uses cat to attempt to read the <code>/etc/shadow</code> file. Since cat is not a standard password management utility on the exclusion list, this action directly matches the rule's logic and will generate an alert.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../obfuscated_files_or_information/" class="btn btn-neutral float-left" title="Obfuscated Files or Information"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../system_information_discovery/" class="btn btn-neutral float-right" title="System Information Discovery">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../obfuscated_files_or_information/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../system_information_discovery/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
