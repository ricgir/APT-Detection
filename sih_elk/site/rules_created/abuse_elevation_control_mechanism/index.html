<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Abuse Elevation Control Mechanism - APT Detection using ELK Stack</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Abuse Elevation Control Mechanism";
        var mkdocs_page_input_path = "rules_created/abuse_elevation_control_mechanism.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> APT Detection using ELK Stack
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../overall_workflow/">Overall Workflow</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../apt_lifecycle/">APT lifecycle</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Setup</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/elk_setup/">ELK</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/vm_setup/">Virtual Machine</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../setup/art_setup/">Atomic Red Team</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Rules created</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../active_scanning/">Active Scanning</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../phishing/">Phishing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../command_and_scripting_interpreter/">Command and Scripting Interpreter</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../boot_or_logon_autostart_execution/">Boot or Logon Autostart Execution</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Abuse Elevation Control Mechanism</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#description">Description</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rule-derivation-from-log-analysis">Rule Derivation from Log Analysis</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-defining-the-behavior">1. Defining the Behavior:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-translating-behavior-to-log-fields">2. Translating Behavior to Log Fields:</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-constructing-the-rule">3. Constructing the Rule:</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#detection-logic">Detection Logic</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#windows-fodhelper-uac-bypass">Windows: Fodhelper UAC Bypass</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ubuntu-sudo-permissions-discovery">Ubuntu: Sudo Permissions Discovery</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#simulation-and-validation">Simulation and Validation</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#windows">Windows</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ubuntu">Ubuntu</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../obfuscated_files_or_information/">Obfuscated Files or Information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../os_credential_dumping/">OS Credential Dumping</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../system_information_discovery/">System Information Discovery</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../remote_services/">Remote Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../automated_collection/">Automated Collection</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../application_layer_protocol/">Application Layer Protocol</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../exfiltration_over_alternative_protocol/">Exfiltration Over Alternative Protocol</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">APT Detection using ELK Stack</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Rules created</li>
      <li class="breadcrumb-item active">Abuse Elevation Control Mechanism</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="detection-rule-privilege-escalation-via-fodhelper-uac-bypass">Detection Rule: Privilege Escalation via Fodhelper UAC Bypass</h1>
<p>Rule ID: <strong>6727ae6d-21ee-40aa-b0a1-bbcb1c58f8cf</strong></p>
<p>Rule Name: Privilege Escalation (T1548: Abuse Elevation Control Mechanism)</p>
<p>MITRE ATT&amp;CK Tactic: <a href="https://attack.mitre.org/tactics/TA0004/">Privilege Escalation</a></p>
<p>MITRE ATT&amp;CK Technique: <a href="https://attack.mitre.org/techniques/T1548/002/">T1548.002, Abuse Elevation Control Mechanism: Bypass User Account Control</a></p>
<h2 id="description">Description</h2>
<p>This rule detects adversaries abusing built-in elevation control mechanisms to execute code with higher privileges. This is a critical step for an attacker to move from a standard user context to an administrator or root context, granting them full control over the system.</p>
<p>On Windows, a common technique is to bypass User Account Control (UAC) by exploiting legitimate applications that are allowed to auto-elevate, such as <code>fodhelper.exe</code>. On Linux, a precursor to privilege escalation is often discovering what permissions the current user has, which is frequently done using the <code>sudo -l</code> command.</p>
<h2 id="rule-derivation-from-log-analysis">Rule Derivation from Log Analysis</h2>
<p>The logic for this rule is derived by identifying adversary actions that are highly indicative of an attempt to gain higher privileges.</p>
<h3 id="1-defining-the-behavior"><strong>1. Defining the Behavior</strong>:</h3>
<p>The goal is to detect either the active bypass of a security control or the reconnaissance that precedes it.</p>
<ul>
<li>
<p><strong>Windows (Bypass)</strong>: The focus is on an untrusted process launching a trusted, auto-elevating executable like <code>fodhelper.exe</code>. This anomalous parent-child relationship is a strong indicator of a hijack.</p>
</li>
<li>
<p><strong>Linux (Discovery)</strong>: The focus is on an adversary checking what commands they can run with elevated privileges. The <code>sudo -l</code> command is a specific artifact of this discovery behavior.</p>
</li>
</ul>
<h3 id="2-translating-behavior-to-log-fields"><strong>2. Translating Behavior to Log Fields</strong>:</h3>
<ul>
<li>
<p><strong>Windows</strong>: The child process (<code>process.name</code>) and its parent (<code>process.parent.name</code>) are analyzed.</p>
</li>
<li>
<p><strong>Linux</strong>: The process (<code>process.name</code>) and its specific arguments (<code>process.args</code>) are inspected.</p>
</li>
</ul>
<h3 id="3-constructing-the-rule"><strong>3. Constructing the Rule</strong>:</h3>
<p>The Windows query identifies the execution of <code>fodhelper.exe</code> and then excludes known legitimate parent processes, flagging any remaining instance as suspicious.</p>
<p>The Ubuntu query looks for the specific combination of the <code>sudo</code> process being run with the <code>-l</code> argument, a high-fidelity indicator of privilege discovery.</p>
<h2 id="detection-logic">Detection Logic</h2>
<h3 id="windows-fodhelper-uac-bypass">Windows: Fodhelper UAC Bypass</h3>
<p>This is a query-based rule that triggers on a single process creation event matching a specific parent-child relationship.</p>
<p><strong>Query</strong>:</p>
<p><code>process.name : "fodhelper.exe" AND NOT (process.parent.name : "explorer.exe" OR process.parent.name : "svchost.exe")</code></p>
<p><strong>Query Explanation</strong>:</p>
<p>The query logic identifies instances where fodhelper.exe is executed by a process other than its expected parent processes.
- The <code>process.name : "fodhelper.exe"</code> clause selects all events where the fodhelper.exe process is created.
- The <code>AND NOT (...)</code> clause then filters out these events if the parent process (<code>process.parent.name</code>) is either <code>explorer.exe</code> or <code>svchost.exe</code>, which are considered legitimate initiators.</p>
<p>The rule triggers an alert for any fodhelper.exe process creation event that does not match the exclusion criteria, indicating a high probability of a UAC bypass attempt.</p>
<h3 id="ubuntu-sudo-permissions-discovery">Ubuntu: Sudo Permissions Discovery</h3>
<p>This query looks for a user attempting to list their sudo permissions, which is often a precursor to privilege escalation.</p>
<p><strong>Query</strong>:</p>
<p><code>process.name:"sudo" and process.args:"-l"</code></p>
<p><strong>Explanation</strong>: </p>
<p>This query alerts when the <code>sudo</code> command is run with the <code>-l</code> (list) flag. Before attempting to escalate privileges, an attacker will almost always use this command to discover what commands they are permitted to run as root.</p>
<h2 id="simulation-and-validation">Simulation and Validation</h2>
<h3 id="windows">Windows</h3>
<p>This rule can be validated by simulating the registry hijack and execution flow used in this UAC bypass technique.</p>
<p><strong>Test Command (PowerShell)</strong>:</p>
<p><code>reg add HKCU\Software\Classes\ms-settings\shell\open\command /v "" /d "C:\Windows\System32\cmd.exe" /f
reg add HKCU\Software\Classes\ms-settings\shell\open\command /v "DelegateExecute" /d "" /f
fodhelper.exe</code></p>
<p>This sequence of commands first modifies the registry key associated with the ms-settings URI handler, pointing it to the Command Prompt (<code>cmd.exe</code>). When fodhelper.exe is executed in the final step, it attempts to open the settings handler, but because of the registry modification, it launches cmd.exe with elevated privileges instead. This action, where <code>cmd.exe</code> (or another shell) becomes the parent of fodhelper.exe, matches the rule's logic and will generate an alert.</p>
<h3 id="ubuntu">Ubuntu</h3>
<p>This test simulates the discovery step an attacker takes after gaining initial access.</p>
<p><strong>Test Command</strong>:</p>
<p><code>sudo -l</code></p>
<p>This command uses the <code>-l</code> (list) option of sudo to show which commands the current user is permitted to run with elevated privileges. Running this command directly matches the rule's logic and will generate an alert.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../boot_or_logon_autostart_execution/" class="btn btn-neutral float-left" title="Boot or Logon Autostart Execution"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../obfuscated_files_or_information/" class="btn btn-neutral float-right" title="Obfuscated Files or Information">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../boot_or_logon_autostart_execution/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../obfuscated_files_or_information/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
